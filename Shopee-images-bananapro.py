import requests
import pandas as pd
from pathlib import Path
from io import BytesIO

from PIL import Image
from google import genai
from google.genai import errors as genai_errors

# ========== 1. é€™è£¡ç›´æ¥å¯«æ­»ä½ çš„ API Key ==========
# åˆ° Google AI Studio ç”¢ç”Ÿä¸€çµ„ GEMINI_API_KEYï¼Œæ•´ä¸²è²¼ä¸Šä¾†
API_KEY = "åˆ° Google AI Studio ç”¢ç”Ÿä¸€çµ„ GEMINI_API_KEYï¼Œæ•´ä¸²è²¼ä¸Šä¾†"

if not API_KEY or "åœ¨é€™è£¡" in API_KEY:
    raise RuntimeError("è«‹å…ˆæŠŠç¨‹å¼ä¸Šæ–¹çš„ API_KEY æ›æˆä½ è‡ªå·±çš„ Gemini API Key")

# å»ºç«‹ Gemini Clientï¼ˆç”¨ Developer APIï¼Œé Vertexï¼‰
client = genai.Client(api_key=API_KEY)

# æ–‡å­—æ¨¡å‹ï¼ˆæŠ½è³£é»ç”¨ï¼‰ & åœ–åƒæ¨¡å‹ï¼ˆæ”¹åœ–ç”¨ï¼‰
TEXT_MODEL = "gemini-2.5-flash"
IMAGE_MODEL = "gemini-3-pro-image-preview"
# å¦‚æœä½ æƒ³ç”¨ã€ŒBanana Proã€ï¼šæŠŠä¸Šé¢ IMAGE_MODEL æ”¹æˆé€™å€‹ï¼š
# IMAGE_MODEL = "gemini-3-pro-image-preview"

# ========== 2. ä½ çš„æª”æ¡ˆï¼æ¬„ä½è¨­å®š ==========
EXCEL_PATH = "products.xlsx"          # TODO: æ›æˆä½ å¯¦éš›çš„ Excel æª”å
OUTPUT_DIR = Path("generated_main")   # ç”¢å‡ºçš„ä¸»åœ–æœƒæ”¾åœ¨é€™å€‹è³‡æ–™å¤¾
OUTPUT_DIR.mkdir(exist_ok=True)

# é€™è£¡ä½ å¯ä»¥ä¾ç…§è‡ªå·±çš„æ¬„ä½åç¨±ä¿®æ”¹
COL_SKU = "SKU"            # æˆ– "å•†å“ID"
COL_IMG_URL = "å•†å“åœ–URL"   # æˆ– "åœ–ç‰‡ç¶²å€"
COL_DESC = "å•†å“æ•˜è¿°"       # æˆ– "æ•˜è¿°" / "å•†å“åœ–æ•˜è¿°"
COL_NAME = "å•†å“åç¨±"       # å¯æœ‰å¯ç„¡ï¼Œå¦‚æœæ²’æœ‰å°±ç©ºå­—ä¸²


# ========== 3. å°å·¥å…·å‡½å¼å€‘ ==========

def download_image_from_url(url: str) -> Image.Image:
    """å¾ç¶²å€ä¸‹è¼‰å•†å“åœ–ï¼Œå›å‚³ PIL Imageã€‚"""
    resp = requests.get(url, timeout=15)
    resp.raise_for_status()
    img = Image.open(BytesIO(resp.content)).convert("RGB")
    return img


def to_square(img: Image.Image, bg_color=(255, 255, 255)) -> Image.Image:
    """è£œæˆ 1:1 æ­£æ–¹å½¢ï¼ˆè¦çš®ä¸»åœ–æ¯”è¼ƒå¥½çœ‹ï¼‰ã€‚"""
    w, h = img.size
    if w == h:
        return img
    size = max(w, h)
    new_img = Image.new("RGB", (size, size), bg_color)
    offset = ((size - w) // 2, (size - h) // 2)
    new_img.paste(img, offset)
    return new_img


def extract_key_points(desc: str, max_points: int = 3):
    """ç”¨æ–‡å­—æ¨¡å‹å¾æ•˜è¿°ä¸­æŠ½ 2~3 å€‹ä¸»åœ–è³£é»ï¼ˆçŸ­å¥ï¼‰ã€‚"""
    if not isinstance(desc, str) or not desc.strip():
        return []

    prompt = (
        "ä»¥ä¸‹æ˜¯ä¸€æ®µè¦çš®å•†å“æ•˜è¿°ï¼Œè«‹å¹«æˆ‘æŒ‘å‡ºæœ€é©åˆæ”¾åœ¨ã€ä¸»åœ–æ–‡å­—ã€ä¸Šçš„è³£é»ï¼š\n\n"
        f"{desc}\n\n"
        "è«‹ç”¨ç¹é«”ä¸­æ–‡è¼¸å‡º 2~3 å€‹çŸ­å¥ï¼Œæ¯å¥ä¸è¶…é 12 å€‹å­—ï¼Œ"
        "ä¸è¦åŠ é …ç›®ç¬¦è™Ÿã€ä¸è¦åŠ æ•¸å­—ç·¨è™Ÿã€‚"
    )

    res = client.models.generate_content(
        model=TEXT_MODEL,
        contents=prompt,
    )

    raw = (res.text or "").strip()
    parts = [p.strip(" ãƒ»â€¢-ã€‚ã€\n\r") for p in raw.split("|") if p.strip()]
    return parts[:max_points]


def build_image_prompt(row, bullets, full_desc: str) -> str:
    """
    çµ¦åœ–åƒæ¨¡å‹ç”¨çš„ promptï¼ˆé€šç”¨ç‰ˆç‰ˆå‹ï¼‰ï¼š

    - ç”¨æä¾›çš„å•†å“ç…§ç‰‡ç•¶ä¸»é«”ï¼Œä¸æ”¹å•†å“æœ¬é«”å¤–è§€
    - åœ–åƒç‰ˆå‹åƒè€ƒã€Œå¤šå­”ç«å±±çŸ³ã€ï¼š
      ä¸Šæ–¹å¤§æ¨™ï¼‹å‰¯æ¨™ã€å·¦å´ icon è³£é»ã€ä¸­å¤®å•†å“ã€å³å´æ”¾å¤§åœˆã€å³ä¸‹å°æ¨™ç±¤
    - æ¨™é¡Œï¼å‰¯æ¨™ï¼è³£é»æ–‡å­—ï¼Œå…¨éƒ¨ç”± AI ä¾æ“šå•†å“æ•˜è¿°è‡ªè¡ŒæŒ‘é¸èˆ‡æ”¹å¯«
    """

    name = str(row.get(COL_NAME) or "").strip()

    # æŠŠå‰é¢æ–‡å­—æ¨¡å‹æŠ½å‡ºçš„ bullets ç•¶ã€Œåƒè€ƒæç¤ºã€ï¼Œä¸ç¡¬å¡é€²ç•«é¢
    clean_bullets = [b.strip() for b in bullets if isinstance(b, str) and b.strip()]
    if clean_bullets:
        bullets_hint = "\n".join(f"- {b}" for b in clean_bullets)
    else:
        bullets_hint = "ï¼ˆæ²’æœ‰é¡å¤–çš„è³£é»æç¤ºï¼Œå¯å®Œå…¨ä¾å•†å“æ•˜è¿°è‡ªè¡Œåˆ¤æ–·ï¼‰"

    prompt = f"""
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è¦çš®é›»å•†ç¾ç·¨ã€‚

æˆ‘æœƒæä¾›ä½ ä¸€å¼µå•†å“åŸå§‹ç…§ç‰‡ï¼Œè«‹ä»¥é‚£å¼µç…§ç‰‡ç‚ºä¸»é«”ï¼Œ
å¹«æˆ‘è¨­è¨ˆä¸€å¼µ 1:1 æ¯”ä¾‹ã€è¦–è¦ºå¸å¼•åŠ›å¼·çš„é›»å•†ä¸»åœ–ï¼Œ
ç‰ˆå‹è«‹åƒè€ƒä¸‹åˆ—çµæ§‹ï¼ˆé¡ä¼¼ã€Œå¤šå­”ç«å±±çŸ³ã€ä¸»åœ–ï¼‰ï¼š

ã€æ•´é«”ç‰ˆå‹çµæ§‹ã€‘
- ä¸Šæ–¹ï¼šç´„ä½”ç•«é¢ä¸Š 1/3ï¼Œæ”¾ç½®å•†å“åç¨±èˆ‡åŠŸèƒ½ç›¸é—œçš„å¤§æ¨™é¡Œã€ å‰¯æ¨™é¡Œã€‚
- å·¦å´ä¸­é–“ï¼šå‚ç›´æ’åˆ— 2ï½3 å€‹ã€Œicon + çŸ­æ–‡å­—ã€çš„è³£é»è† å›Šã€‚
- ä¸­å¤®åä¸‹ï¼šå¤§é¢ç©é¡¯ç¤ºå•†å“æœ¬é«”ï¼Œæ­é…é©åˆçš„å ´æ™¯èƒŒæ™¯ã€‚
- å³å´ä¸­ä¸Šï¼šä¸€å€‹åœ“å½¢æ”¾å¤§åœˆæˆ–æ°£æ³¡ï¼Œæ”¾å¤§ä¸¦å¼·èª¿å•†å“çš„æŸå€‹å±€éƒ¨ç‰¹æ€§ï¼Œæ—é‚Šæ­é…ä¸€å¥çŸ­æ–‡å­—ã€‚
- å³ä¸‹è§’ï¼šå°å‹æ¨™ç±¤ï¼ˆä¾‹å¦‚è¦æ ¼æˆ–å‡ºè²¨æ–¹å¼ï¼‰ï¼Œå¤–è§€åƒè† å›Šæˆ–æ–œè§’æ¨™ç±¤ã€‚

ã€å•†å“ç…§ç‰‡ä½¿ç”¨è¦å‰‡ã€‘
- ä¸€å®šè¦ä½¿ç”¨æˆ‘æä¾›çš„å•†å“åœ–ç‰‡ä½œç‚ºä¸»è§’ã€‚
- ä¸è¦æ”¹è®Šå•†å“æœ¬é«”çš„å¤–è§€ã€å½¢ç‹€èˆ‡é¡è‰²ï¼Œä¸è¦æŠŠå•†å“æ›æˆåˆ¥çš„æ±è¥¿ã€‚
- å¯ä»¥èª¿æ•´èƒŒæ™¯ã€å…‰ç·šã€æ§‹åœ–èˆ‡åŠ ä¸Šæ–‡å­—ã€åœ–æ¨™ï¼Œä½†ä¸è¦è®“ç•«é¢è®Šå¾—å¤ªèŠ±ã€‚
- è«‹æŠŠå•†å“æ”¾åœ¨ç•«é¢ä¸­å¤®æˆ–ç•¥å¾®åä¸‹çš„ä½ç½®ï¼Œä¿æŒæ¸…æ¥šã€ç«‹é«”ã€æœ‰è³ªæ„Ÿã€‚
- æ‰€æœ‰è®ŠåŒ–éƒ½å¿…é ˆè®“äººä¸€çœ¼çœ‹å¾—å‡ºé€™å°±æ˜¯åŸæœ¬çš„é‚£å€‹å•†å“ã€‚

ã€èƒŒæ™¯èˆ‡å ´æ™¯ã€‘
- èƒŒæ™¯è«‹è¨­è¨ˆç‚ºç°¡æ½”ä½†æœ‰å±¤æ¬¡çš„å ´æ™¯æˆ–æ¼¸å±¤è‰²ï¼Œé¡è‰²èˆ‡å•†å“æœ¬èº«å”èª¿ã€‚
- å¯ä»¥åŠ å…¥èˆ‡å•†å“ç”¨é€”ç›¸é—œçš„å ´æ™¯å…ƒç´ ï¼ˆä¾‹å¦‚æ°´æ—ç”¨å“å¯æœ‰æ°´è‰ã€é­šç¼¸æ„Ÿï¼‰ï¼Œ
  ä½†è¦ä¿æŒé©åº¦æ¨¡ç³Šï¼Œé¿å…æ¶èµ°å•†å“ç„¦é»ã€‚
- ä½¿ç”¨å…‰å½±èˆ‡æ™¯æ·±è®“å•†å“å¾èƒŒæ™¯ä¸­è·³å‡ºä¾†ï¼Œç‡Ÿé€ å°ˆæ¥­ã€ä¹¾æ·¨ä¸”è¦–è¦ºå¸å¼•åŠ›å¼·çš„æ„Ÿè¦ºã€‚

ã€æ–‡æ¡ˆç”¢ç”Ÿè¦å‰‡ï¼ˆé‡é»ï¼ï¼‰ã€‘
è«‹ä½ æ ¹æ“šå•†å“åç¨±èˆ‡å•†å“æ•˜è¿°ï¼Œè‡ªè¡ŒæŒ‘é¸ä¸¦æ’°å¯«ä¸»æ¨™ã€ å‰¯æ¨™èˆ‡è³£é»æ–‡å­—ï¼š

1. ä¸»æ¨™ï¼ˆé†’ç›®æ¨™é¡Œï¼‰
   - ä»¥ç¹é«”ä¸­æ–‡å¯«ä¸€è¡Œä¸»æ¨™ï¼Œå­—æ•¸å»ºè­° 8ï½12 å€‹å­—å…§ã€‚
   - è¦èƒ½å¿«é€Ÿèªªæ˜é€™å€‹å•†å“ã€Œæœ€é‡è¦çš„æ ¸å¿ƒåƒ¹å€¼ã€æˆ–ã€Œä¸»è¦ç”¨é€”ã€ã€‚
   - å¯ä»¥åŒ…å«ç”¢å“åç¨±çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸éœ€è¦å®Œå…¨ç­‰æ–¼å“åã€‚

2. å‰¯æ¨™ï¼ˆå¼·èª¿ç›Šè™•ï¼‰
   - ä»¥ç¹é«”ä¸­æ–‡å¯«ä¸€è¡Œå‰¯æ¨™ï¼Œå­—æ•¸å»ºè­° 12ï½20 å€‹å­—å…§ã€‚
   - ç”¨ä¾†è£œå……ä¸»æ¨™ï¼Œå¼·èª¿ä½¿ç”¨å¾Œçš„å¥½è™•ã€ä½¿ç”¨æƒ…å¢ƒæˆ–å·®ç•°åŒ–å„ªå‹¢ã€‚
   - å‰¯æ¨™æ”¾åœ¨ä¸»æ¨™ä¸‹é¢ï¼Œå­—é«”ç•¥å°ä½†åŒæ¨£æ¸…æ™°ã€‚

3. é—œéµç‰¹æ€§è³£é»ï¼ˆæ­é… iconï¼‰
   - è«‹æ•´ç†å‡º 2ï½3 å€‹ã€Œæœ€é‡è¦çš„åŠŸèƒ½æˆ–å„ªé»ã€ï¼Œæ¯å€‹ç”¨ 4ï½8 å€‹ä¸­æ–‡å­—è¡¨ç¤ºã€‚
   - é€™äº›è³£é»æ–‡å­—æœƒæ”¾åœ¨å·¦å´çš„ icon è† å›Šä¸­ï¼Œä»¥åŠå³å´æ”¾å¤§åœˆé™„è¿‘ã€‚
   - æ–‡å­—è¦ç°¡çŸ­æœ‰åŠ›ï¼Œé©åˆç¸®åœ–ç‹€æ…‹ä¸‹å¿«é€Ÿé–±è®€ã€‚

4. æ–‡æ¡ˆä¾†æºé™åˆ¶
   - æ‰€æœ‰æ–‡æ¡ˆå…§å®¹å¿…é ˆã€Œæœ‰æ ¹æ“šã€ï¼Œåªèƒ½ä¾†è‡ªä¸‹æ–¹å•†å“æ•˜è¿°æˆ–å…¶åˆç†çš„æ¦‚æ‹¬èˆ‡æ”¹å¯«ã€‚
   - ä¸å¯ä»¥æ†‘ç©ºæ–°å¢å•†å“æ²’æœ‰çš„åŠŸèƒ½æˆ–èª‡å¤§ç™‚æ•ˆã€‚
   - ä½ å¯ä»¥é‡çµ„ã€ç²¾ç°¡ã€æ”¹å¯«æ•˜è¿°ä¸­çš„ç”¨è©ï¼Œä½†ä¸è¦å‰µé€ å®Œå…¨ç„¡é—œçš„æ–°è³£é»ã€‚

ã€è¼”åŠ©è³£é»æç¤ºï¼ˆç”±å¦ä¸€å€‹æ¨¡å‹å…ˆå¾æ•˜è¿°ä¸­æŠ“å‡ºä¾†çµ¦ä½ åƒè€ƒï¼Œå¯ä»¥æ”¹å¯«æˆ–ä¸ä½¿ç”¨ï¼‰ã€‘
{bullets_hint}

ã€å•†å“åŸºæœ¬è³‡è¨Šã€‘
- å•†å“åç¨±ï¼ˆåƒ…ä¾›ä½ ç†è§£ï¼Œä¸ä¸€å®šè¦å®Œæ•´å¯«åœ¨ä¸»æ¨™è£¡ï¼‰ï¼š{name or "ï¼ˆæœªæä¾›åç¨±ï¼‰"}

ã€å•†å“å®Œæ•´æ•˜è¿°ï¼ˆè«‹ä»¥é€™æ®µå…§å®¹ç‚ºä¾æ“šï¼Œè‡ªå·±æŒ‘é¸åˆé©çš„æ¨™é¡Œã€å‰¯æ¨™èˆ‡è³£é»ï¼‰ã€‘
{full_desc}

è«‹ç›´æ¥åœ¨ç”Ÿæˆçš„åœ–ç‰‡ä¸­å‘ˆç¾ä½ è¨­è¨ˆå¥½çš„ä¸»æ¨™ã€å‰¯æ¨™èˆ‡è³£é»æ–‡å­—ï¼Œ
ä¸ç”¨åœ¨æ–‡å­—å›æ‡‰ä¸­å†è¼¸å‡ºä¸€æ¬¡æ–‡æ¡ˆã€‚
"""

    return prompt.strip()


def generate_edited_image(prompt: str, base_image: Image.Image, out_path: Path) -> bool:
    """
    ç”¨ã€Œæ–‡å­— + åŸå§‹å•†å“åœ–ã€å‘¼å« Gemini åšåœ–åƒç·¨è¼¯ã€‚
    å¦‚æœé‡åˆ° ServerError æˆ–å…¶ä»–éŒ¯èª¤ï¼Œå›å‚³ Falseï¼Œä¸è®“æ•´æ”¯ç¨‹å¼ä¸­æ­¢ã€‚
    """
    try:
        response = client.models.generate_content(
            model=IMAGE_MODEL,
            contents=[prompt, base_image],
        )
    except genai_errors.ServerError as e:
        # é€™å°±æ˜¯ä½ å‰›å‰›é‡åˆ°çš„ 500 INTERNAL é€™é¡
        print(f"âš ï¸ ç”¢åœ–æ™‚ç™¼ç”Ÿ ServerErrorï¼š{e}")
        return False
    except Exception as e:
        # å…¶ä»–ä»»ä½•ç•°å¸¸ä¹Ÿç•¶ä½œé€™å¼µåœ–å¤±æ•—
        print(f"âš ï¸ ç”¢åœ–æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼š{e}")
        return False

    # æ­£å¸¸æ‹¿åˆ° responseï¼Œå¾ parts æŠ“åœ–
    for part in response.parts:
        if part.inline_data is not None:
            img = part.as_image()
            img.save(out_path)
            return True

    print("âš ï¸ å›æ‡‰è£¡æ²’æœ‰åœ–ç‰‡è³‡æ–™ï¼ˆå¯èƒ½æ˜¯è¢«å®‰å…¨å¯©æŸ¥æ“‹æ‰æˆ–æ¨¡å‹åªå›æ–‡å­—ï¼‰")
    return False


# ========== 4. ä¸»ç¨‹å¼ï¼šè·‘æ•´å€‹ Excelï¼Œè‡ªå‹•ç”¢ä¸»åœ– ==========

def main():
    print(f"è®€å– Excelï¼š{EXCEL_PATH}")
    df = pd.read_excel(EXCEL_PATH)

    skipped_records = []  # â­ æ–°å¢ï¼šç”¨ä¾†è¨˜éŒ„å¤±æ•—ï¼è¢«è·³éçš„å•†å“

    for idx, row in df.iterrows():
        # 1) å…ˆå¾ Excel æ‹¿åŸæœ¬çš„ SKU
        raw_sku = row.get(COL_SKU) or row.get("å•†å“ID")

        # 2) å¦‚æœæ˜¯ç©ºç™½ / NaNï¼Œå°±ç”¨åˆ—ç·¨è™Ÿè‡ªå‹•å¸¶ä¸€å€‹ç·¨è™Ÿï¼ˆ4 ç¢¼è£œé›¶ï¼‰
        if pd.isna(raw_sku) or str(raw_sku).strip() == "":
            sku = f"{idx + 1:04d}"   # ç¬¬ 0 åˆ— -> "0001", ç¬¬ 1 åˆ— -> "0002"...
        else:
            sku = str(raw_sku).strip()

        url = str(row.get(COL_IMG_URL) or row.get("åœ–ç‰‡ç¶²å€") or "").strip()
        desc = str(row.get(COL_DESC) or row.get("æ•˜è¿°") or "").strip()
        name = str(row.get(COL_NAME) or "").strip()

        print(f"\n=== è™•ç†ç¬¬ {idx} åˆ—ï¼ˆSKU={sku}ï¼‰ ===")

        # å¦‚æœæ²’åœ–ç‰‡ URLï¼Œä¹Ÿç®—ä¸€ç¨®ã€Œè·³éã€ï¼Œé †ä¾¿è¨˜éŒ„èµ·ä¾†
        if not url:
            print("âš ï¸ é€™åˆ—æ²’æœ‰åœ–ç‰‡ URLï¼Œè·³é")
            skipped_records.append({
                "SKU": sku,
                "å•†å“åç¨±": name,
                "å•†å“æ•˜è¿°": desc,
                "å•†å“åœ–URL": url,
            })
            continue

        # 1) ä¸‹è¼‰åŸå§‹å•†å“åœ–
        try:
            base_img = download_image_from_url(url)
            base_img = to_square(base_img)  # å…ˆè£œæˆ 1:1ï¼Œä¹‹å¾Œæ”¹åœ–å°±æœƒæ˜¯æ­£æ–¹å½¢
            print("âœ… åœ–ç‰‡ä¸‹è¼‰æˆåŠŸ")
        except Exception as e:
            print(f"âš ï¸ ä¸‹è¼‰åœ–ç‰‡å¤±æ•—ï¼š{e}")
            # ä¸‹è¼‰å¤±æ•—ä¹Ÿè¨˜éŒ„èµ·ä¾†
            skipped_records.append({
                "SKU": sku,
                "å•†å“åç¨±": name,
                "å•†å“æ•˜è¿°": desc,
                "å•†å“åœ–URL": url,
            })
            continue

        # 2) ç”¨ Gemini æŠ½è³£é»ï¼ˆçµ¦åœ–ç‰‡æ¨¡å‹ç•¶åƒè€ƒï¼‰
        bullets = extract_key_points(desc)
        print("ä¸»åœ–è³£é»ï¼ˆAI æŠ½å‡ºï¼‰ï¼š", bullets)

        # 3) çµ„ promptï¼ˆè®“ Banana Pro è‡ªå·±ç”Ÿæ¨™é¡Œï¼å‰¯æ¨™ï¼è³£é»ï¼‰
        #    å¦‚æœä½ æœ‰åšæˆªæ–·ï¼Œå¯ä»¥åœ¨é€™è£¡ç”¨ desc[:800] ä¹‹é¡
        prompt = build_image_prompt(row, bullets, desc)

        # 4) ä¸Ÿçµ¦ Gemini åšåœ–åƒç·¨è¼¯
        out_file = OUTPUT_DIR / f"{sku}_main.png"
        ok = generate_edited_image(prompt, base_img, out_file)

        if ok:
            print(f"ğŸ¨ å·²è¼¸å‡ºä¸»åœ–ï¼š{out_file}")
        else:
            print("âš ï¸ ç”¢åœ–å¤±æ•—ï¼Œæ­¤å•†å“å°‡åˆ—å…¥è·³éæ¸…å–®")
            skipped_records.append({
                "SKU": sku,
                "å•†å“åç¨±": name,
                "å•†å“æ•˜è¿°": desc,
                "å•†å“åœ–URL": url,
            })
            # ä¸ raiseï¼Œç›´æ¥è™•ç†ä¸‹ä¸€åˆ—
            continue

    # è¿´åœˆè·‘å®Œå¾Œï¼ŒæŠŠæ‰€æœ‰è·³éçš„å•†å“è¼¸å‡ºæˆä¸€å€‹ Excel
    if skipped_records:
        skipped_df = pd.DataFrame(
            skipped_records,
            columns=["SKU", "å•†å“åç¨±", "å•†å“æ•˜è¿°", "å•†å“åœ–URL"]
        )
        skipped_path = "skipped_products.xlsx"
        skipped_df.to_excel(skipped_path, index=False)
        print(f"\nâš ï¸ å…± {len(skipped_records)} ç­†å•†å“ç”¢åœ–å¤±æ•—æˆ–è¢«è·³éï¼Œå·²è¼¸å‡ºï¼š{skipped_path}")
    else:
        print("\nâœ… æ‰€æœ‰å•†å“çš†æˆåŠŸç”¢åœ–ï¼Œæ²’æœ‰è·³éé …ç›®ã€‚")


if __name__ == "__main__":
    main()
